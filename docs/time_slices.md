# Временные срезы зелени (спецификация)

Цель: определить воспроизводимый способ построения годовых срезов «зелени» для Ташкента (AOI), чтобы можно было:
- сравнивать годы между собой (loss/gain),
- агрегировать метрики по сетке/районам,
- использовать один и тот же пайплайн независимо от того, где он запущен.

Эта спецификация описывает **что** считаем и **какие параметры фиксируем**. Реализация пайплайна (скачивание сцен, композит, COG, полигонализация) будет отдельной задачей.

## Термины
- **AOI**: область интереса (граница Ташкента) в WGS84 (EPSG:4326), хранится в релизе: `data/releases/<run_id>/aoi/<aoi_id>.geojson`.
- **Срез**: временной интервал (например, лето конкретного года), в пределах которого собирается композит NDVI.
- **NDVI**: `(NIR - RED) / (NIR + RED)`.
- **Зелёная маска**: растр (0/1) на основе NDVI-порога, после маскирования облаков/снега/тени.

## Датасет (рекомендуемый)
**Sentinel-2 Level-2A (Surface Reflectance)**.

Причины:
- глобальная доступность,
- 10m для RED/NIR,
- есть классификация сцены (SCL) для маскирования облаков/тени/снега.

Бэнды:
- RED: `B04` (10m)
- NIR: `B08` (10m)
- Scene Classification: `SCL` (обычно 20m; при композите приводим к 10m ближайшим соседом)

## Окно сезона (фиксируемое)
Для сопоставимости между годами берём **летний композит**:
- `start_date = YYYY-06-01`
- `end_date = YYYY-09-01`

Примечание: даты можно менять под региональную фенологию, но тогда нужно пересчитать все годы одинаково и зафиксировать конфиг.

## Фильтры входных сцен
Минимальные требования (по умолчанию):
- фильтр по покрытию облаками сцены: `eo:cloud_cover <= 60` (если метаданные доступны)
- использовать только L2A (SR)

## Маскирование (cloud/snow/shadow)
Метод по умолчанию: **SCL-mask**.

Исключаем пиксели со значениями SCL (Sentinel-2 SCL):
- `3` cloud shadow
- `8` cloud medium probability
- `9` cloud high probability
- `10` thin cirrus
- `11` snow/ice

Остальные классы считаем валидными для расчёта NDVI.

## Композитирование
Цель: получить стабильный годовой слой без влияния выбросов/остаточной облачности.

По умолчанию:
- композит по NDVI: `median` по времени,
- минимум валидных наблюдений на пиксель: `min_valid_observations = 3` (если меньше, пиксель помечается как NoData).

## Классификация «зелени»
По умолчанию:
- `green_ndvi_threshold = 0.30`
- `green_mask = ndvi >= threshold`

Порог должен быть зафиксирован в конфиге, и любые изменения порога требуют пересчёта всей серии.

## Постобработка (шум/пиксельный мусор)
По умолчанию (для mask 0/1):
- морфология: opening(1px) + closing(1px)
- удаление очень мелких компонент (опционально на векторизации)

Параметры постобработки также фиксируются в конфиге.

## Выходные артефакты (структура релиза)
Для каждого года `YYYY`:
- `data/releases/<run_id>/raster/green_mask_<YYYY>.tif` (COG/GeoTIFF, 0/1, **EPSG:32642 (UTM 42N)**, 10m)
- (опционально) `data/releases/<run_id>/raster/ndvi_<YYYY>.tif` (COG/GeoTIFF, float32, **EPSG:32642 (UTM 42N)**, 10m)
- (опционально) `data/releases/<run_id>/vector/green_sat_<YYYY>.parquet` (упрощённые полигоны зелени)

Метаданные:
- `data/releases/<run_id>/manifest.json` должен включать даты и параметры источника (диапазон дат, коллекция, пороги) и список файлов (sha256/size).

Примечание по CRS: Sentinel-2 сцены в Earth Search идут в UTM-тайлах, и на MVP мы сохраняем растр в исходной UTM сетке (метры), чтобы:
- пиксель был стабильным 10m,
- последующие площади/агрегации по сетке считались корректно.

Для веб-рендера (MapLibre) позже можно будет отдельно собрать тайлы/пере-проекцию.

## Конфигурация
Машиночитаемый конфиг хранится в `packages/data/src/time_slices.json`.
